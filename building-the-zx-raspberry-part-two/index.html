
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta name="description" content="The personal blog of PJ Evans">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="">
    <link href="https://fonts.googleapis.com/css2?family=Nothing+You+Could+Do&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Coustard&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

    <link href="/src/css/mrpjevans.css" rel="stylesheet">

		<link rel="icon" type="image/png" size="256x256" href="/images/pj-blog-logo-256.png">

		<link rel="icon" type="image/png" size="512x512" href="/images/pj-blog-logo-512.png">

		<link rel="alternate" type="application/rss+xml" title="Mr PJ Evans Blog Feed" href="https://mrpjevans.com/feed/feed.xml">

		<title>Mr PJ Evans | Building The ZX Raspberry – Part Two</title>

  </head>
  <body data-bs-theme="dark">

    <div class="container">
      <div class="row justify-content-md-center">
        <div class="col-md-8 col-sm-12 col-lg-6">

					<header>
						<nav class="navbar bg-dark navbar-expand-lg border-bottom border-body" data-bs-theme="dark">
							<div class="container-fluid">
								<a class="navbar-brand logo" href="/">Mr PJ Evans</a>
								<div>
									<div>
										<ul class="navbar-nav me-auto mb-2 mb-lg-0">
											<li class="nav-item">
											<a class="nav-link " href="/tags">Tags</a>
											</li>
											<li class="nav-item">
												<a class="nav-link " href="/about">About</a>
											</li>
										</ul>
									</div>	
								</div>
							</div>
						</nav>
					</header>

					<main>
          	
  

  

  

  
    
    


    <h1 class="h1-with-date">Building The ZX Raspberry – Part Two</h1>

<p class="meta-date text-center">15 Dec 2015</p>

<picture><source type="image/webp" srcset="/images/IMG_0437-1000w.webp 1000w"><img src="/images/IMG_0437-1000w.jpeg" alt="" width="1000" height="1333"></picture>

<article>
  <p><em>In which our hero enters the (keyboard) matrix…</em></p><p>Ok, time to burn stuff. After hatching a plan in <a href="http://mrpjevans.com/2015/12/building-the-zx-raspberry-part-one/?ref=stowe.local">Part One</a>, I’m now ready to proceed with my Frankenspeccy. But first, some more planning – what am I going to build? Well, this… </p><figure class="kg-card kg-image-card"><picture><source type="image/webp" srcset="/images/ZXRaspberryCircuit1-905w.webp 905w" sizes="(min-width: 720px) 720px"><img src="/images/ZXRaspberryCircuit1-905w.jpeg" class="kg-image" alt="" loading="lazy" width="905" height="1182" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/ZXRaspberryCircuit1.png 600w, http://stowe.local:2368/content/images/2018/11/ZXRaspberryCircuit1.png 905w"></picture></figure><p>I need to connect all 13 lines from the Speccy’s membrane to the microcontroller so it can read them. This will be done by outputting current on the address lines (the group of 8 or KB2) and reading the results on the data lines (the group of 5, KB1). Due to a problem with reading currents known as <a href="https://en.wikipedia.org/wiki/Floating_ground?ref=stowe.local">floating</a>, I need to use pull-up resistors on the data lines. This has been taken from the original Instructables article but since them I’ve realised that the Pro Micro may well have built-in pull-up resistors on the chip as the Arduino Uno does. In other words, this might not have been a necessary step. Still, won’t hurt. <a href="http://mrpjevans.com/2016/02/building_zx_raspberry_part_4/?ref=stowe.local">Update: I was correct, see Part 4</a>.</p><p>A <a href="https://en.wikipedia.org/wiki/Pull-up_resistor?ref=stowe.local">pull-up resistor setup</a> means switches work backwards to how you would normally think. If you detect a high state on the microcontroller, the button is not being pressed. If low, your button is cutting off the supply and is considered pressed. A tad counter-intuative but it makes life easier.</p><p>5V from the Pro Micro is sent to the resistors and then back into the inputs. So, everything initially registers as high current. The KB1 membrane ribbon is also connected to the stripboard. If it connects with a line on KB2, i.e. a button is pressed, it will draw the current to the address line and the data pin will read low. A key has been pressed. Our controller will scan each data line on each address line to detect keypresses. A scan of 40 combinations in all (8 x 5). Even this cheap piece of hardware will be able to do this several thousand times a second.</p><p>On the address lines you’ll notice a row of diodes. I’ve added this as a test build of the original circuit revealed a problem: no more than one key could be pressed at once. This was due to a restriction in the software design and also a short-circuit that could be caused by pressing more than one key on the same data line. One would ground to the other’s address line. This is easily fixed by only allowing current to flow in one direction, i.e. line up some diodes.</p><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/ZXRaspShortCircuit-567w.webp 567w"><img src="/images/ZXRaspShortCircuit-567w.jpeg" class="kg-image" alt="" loading="lazy" width="567" height="637"></picture><figcaption><span style="white-space: pre-wrap;">When Caps and P are pressed together, a short occurs so nothing flows to the data line</span></figcaption></figure><p>The final bill of materials is:</p><p>1 x ZX Spectrum case with keyboard membrane (Do NOT hurt a working Speccy. I’ll tell on you.)<br>1 x SparkFun Pro Micro (or equivalent)<br>2 x Pieces of stripboard large enough to accommodate the components and keyboard connectors<br>6 x 10k resistors<br>8 x Diodes (e.g. 1N4148)<br>1 x ZX Spectrum Keyboard connector pair (can be found on eBay or harvested from a broken Spectrum)<br>1 x Push-to-make momentary contact button<br>Lots of ribbon cable or wire</p><p><em>Common-sense disclaimer time. Should you wish to undertake this project I am not responsible for anything you do to your Speccy (or anyone else’s for that matter) or yourself, your family and small pets. If you are not confident in what you are doing, do not proceed.</em></p><p>The first step was to give the casing a darn good clean, then cut up two pieces of stripboard; one for each membrane connector. It is very important you carefully work our where to place these on the case, as the ribbons from the membrane must not be put under any stress, such as meeting mortgage payments or awkward social situations. Ideally, take your cue from a ZX Spectrum motherboard and line them up accordingly. My KB1 connector ended up a little higher in the case as the ribbon had been trimmed. I then marked out the position using some masking tape.</p><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/IMG_2263-2000w.webp 2000w" sizes="(min-width: 720px) 720px"><img src="/images/IMG_2263-2000w.jpeg" class="kg-image" alt="" loading="lazy" width="2000" height="1500" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/IMG_2263.jpg 600w, http://stowe.local:2368/content/images/size/w1000/2018/11/IMG_2263.jpg 1000w, http://stowe.local:2368/content/images/size/w1600/2018/11/IMG_2263.jpg 1600w, http://stowe.local:2368/content/images/2018/11/IMG_2263.jpg 2000w"></picture><figcaption><span style="white-space: pre-wrap;">Measure Twice and all that…</span></figcaption></figure><p>The ZX Spectrum keyboard connectors are very delicate and chances are you’re using old ones that have been harvested. Make sure everything is clean and, if required, manipulate the contacts carefully so they make a good connection with the ribbon. Most important of all, make sure you solder them into position the correct way around! Only one side of the ribbon has its contacts exposed and these need to match up with the flat side of each connector.</p><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/IMG_22441-2000w.webp 2000w" sizes="(min-width: 720px) 720px"><img src="/images/IMG_22441-2000w.jpeg" class="kg-image" alt="" loading="lazy" width="2000" height="758" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/IMG_22441.jpg 600w, http://stowe.local:2368/content/images/size/w1000/2018/11/IMG_22441.jpg 1000w, http://stowe.local:2368/content/images/size/w1600/2018/11/IMG_22441.jpg 1600w, http://stowe.local:2368/content/images/2018/11/IMG_22441.jpg 2000w"></picture><figcaption><span style="white-space: pre-wrap;">The ZX Spectrum keyboard connectors</span></figcaption></figure><p>Soldering the two stripboards is straightforward enough, but here are some things to be aware of:</p><ul><li>Make sure you cut the tracks between the resistors and the diode, otherwise they won’t be much use</li><li>Remember that the 5V line needs to go to all the resistors, so short out the lines on the stripboard with some wire or solder blobs.</li><li>Work out where the Pro Micro is going to site and make sure you have long enough cable (too much is good, you can always cut it back)</li><li>Measure, measure and measure again</li></ul><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/IMG_2245-2000w.webp 2000w" sizes="(min-width: 720px) 720px"><img src="/images/IMG_2245-2000w.jpeg" class="kg-image" alt="" loading="lazy" width="2000" height="1500" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/IMG_2245.jpg 600w, http://stowe.local:2368/content/images/size/w1000/2018/11/IMG_2245.jpg 1000w, http://stowe.local:2368/content/images/size/w1600/2018/11/IMG_2245.jpg 1600w, http://stowe.local:2368/content/images/2018/11/IMG_2245.jpg 2000w"></picture><figcaption><span style="white-space: pre-wrap;">KB1 Assembly</span></figcaption></figure><p>Solder each line to the Pro Micro (this is a little more delicate) as shown in the diagram. Input names can vary (this is the SparkFun version) on different controllers. So long as it’s going into a pin that can be configured as a digital input, you’re good.</p><p>I had a few shorts on my first attempt (the joy of cutting tracks on stripboard) so be sure to go over everything with a multimeter.</p><p>You’ll also notice another component: A button. Early on I realised I had a problem. In order to use the emulator I had in mind on the Pi I was going to need the use of function keys (F1, F2 etc). The ZX Spectrum keyboard has no space for these and I wanted to keep all original functionality in place. I decided to build in a keyboard ‘mapping’ mode. By detecting the switch being pressed (just as if it was an extra key) I could toggle which mode the software was in and effectively have two or more keyboards. Pressing the button will take it into ‘special key’ mode which would re-map keys to whatever I wanted.</p><p>The button assembly is identical to the keys except that it goes straight to ground. The Pro Micro has a few spare ground contacts.</p><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/IMG_2259-2000w.webp 2000w" sizes="(min-width: 720px) 720px"><img src="/images/IMG_2259-2000w.jpeg" class="kg-image" alt="" loading="lazy" width="2000" height="1500" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/IMG_2259.jpg 600w, http://stowe.local:2368/content/images/size/w1000/2018/11/IMG_2259.jpg 1000w, http://stowe.local:2368/content/images/size/w1600/2018/11/IMG_2259.jpg 1600w, http://stowe.local:2368/content/images/2018/11/IMG_2259.jpg 2000w"></picture><figcaption><span style="white-space: pre-wrap;">A Completed Mess Of Wires</span></figcaption></figure><p>Once all soldered together I very carefully attached the original keyboard membrane to the connectors and hooked up the Pro Micro to my Mac. Of course, nothing happened because I haven’t uploaded any software to the microcontroller yet. Still, nothing went bang, so that was nice too.</p><p>I would like to boast that I got the software up and running in minutes and all was well. Err, no. It took four complete re-writes of the code before I finally figured everything out. I’ll spare you the gory details here but it turns out writing keyboard controllers is not the walk in the park you’d think. The biggest hitch was the Raspberry Pi being very sensitive about how much information was pushed through it. Code that performed very well on my Mac would stutter or break altogether on the Pi. The less ‘chatty’ I made my code, the better it got.</p><p>Anyway, <a href="http://mrpjevans.com/wp-content/uploads/2015/12/ZXRaspberryScanner.txt?ref=stowe.local">here is the final (yeah, right) sketch.</a> After initial setup, if performs two nested loops. The first selects one address line and sets it low, allowing it to receive current. The nested loop goes through the five data lines looking for a low signal. If one is found, I now know the data line and address line it is on. A simple array mimicking the ZX Spectrum keyboard matrix allows me to map it to a letter which I can output to the USB master via the insanely easy-to-use Keyboard object in the Arduino IDE. To allow for multiple keypresses (essential for gaming) I had to track each individual key state and detect releases as well as presses. So, the keyboard is as ‘real time’ as possible.</p><p>If you want to play with this (and please, be my guest) take a copy and have fun. I’ll probably continue to tinker too. Either way, it’s just a matter of cutting and pasting the above into a Sketch in the Arduino IDE and uploading it to the Pro Micro.</p><p>Lots of testing next. I made sure all the keys worked (obviously) but also that things like extended mode would work correctly in ZX Spectrum emulators. It took a good few days work to get it all perfect.</p><p>If you’re only after a USB keyboard, then all there is left to do is to glue or stick in the stripboard at your marked locations, mount the key mode button somewhere useful (if you’re going to have your regular keyboard to hand, you don’t really need the button anyway) and plug in a USB cable to the Pro Micro (I got an angled one for a snug fit). Reassemble the ZX Spectrum and you’re done.</p><figure class="kg-card kg-image-card kg-card-hascaption"><picture><source type="image/webp" srcset="/images/IMG_2264-1-2000w.webp 2000w" sizes="(min-width: 720px) 720px"><img src="/images/IMG_2264-1-2000w.jpeg" class="kg-image" alt="" loading="lazy" width="2000" height="1500" srcset="http://stowe.local:2368/content/images/size/w600/2018/11/IMG_2264-1.jpg 600w, http://stowe.local:2368/content/images/size/w1000/2018/11/IMG_2264-1.jpg 1000w, http://stowe.local:2368/content/images/size/w1600/2018/11/IMG_2264-1.jpg 1600w, http://stowe.local:2368/content/images/2018/11/IMG_2264-1.jpg 2000w"></picture><figcaption><span style="white-space: pre-wrap;">Completed keyboard – just add USB</span></figcaption></figure><p>But that’s not my tempo.</p><p>Next, it’s time to get the Speccy an ice cream. Raspberry flavour.</p><p><a href="http://mrpjevans.com/2015/12/building-the-zx-raspberry-part-3/?ref=stowe.local"><em>Part 3…</em></a></p>
</article>


<div class="row">
  <div class="col-12 mb-3">
    
      
        <a href="/tags/makes" class="badge rounded-pill text-bg-primary">Makes</a>
      
    
      
        <a href="/tags/raspberry-pi" class="badge rounded-pill text-bg-primary">Raspberry Pi</a>
      
    
      
        <a href="/tags/vintage-tech" class="badge rounded-pill text-bg-primary">Vintage Tech</a>
      
    
      
    
  </div>
</div>
<p class="backlink">
  <a href="/">Home</a>
</p>
					</main>

        </div>

        <div class="row justify-content-md-center p-0">
					
          <footer class="col-md-8 col-sm-12 col-lg-6 footer">

            <hr>

            <div xmlns:cc="http://creativecommons.org/ns#" xmlns:dct="http://purl.org/dc/terms/">
						  
							<a id="rss-icon" href="/feed/feed.xml" aria-label="RSS Feed">
								<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" class="bi bi-rss-fill" viewBox="0 0 16 16">
  <path d="M2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2zm1.5 2.5c5.523 0 10 4.477 10 10a1 1 0 1 1-2 0 8 8 0 0 0-8-8 1 1 0 0 1 0-2m0 4a6 6 0 0 1 6 6 1 1 0 1 1-2 0 4 4 0 0 0-4-4 1 1 0 0 1 0-2m.5 7a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3"></path>
</svg>
							</a>

							<a href="http://creativecommons.org/licenses/by-nc-sa/4.0/?ref=chooser-v1" target="_blank" rel="license noopener noreferrer">
							<span class="cc">
								<picture><source type="image/webp" srcset="/images/by-nc-sa.eu-403w.webp 403w"><img src="/images/by-nc-sa.eu-403w.jpeg" alt="CC BY-NC-SA" width="403" height="141"></picture>
							</span>
						</a>

            <p></p>

          </div></footer>
        </div>

      </div>

    </div>

		<script data-goatcounter="https://mrpjevans.goatcounter.com/count" async="" src="//gc.zgo.at/count.js"></script>
  </body>
</html>